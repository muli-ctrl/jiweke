<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jiweke Checkout</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID&currency=USD"></script>
  <style>
    :root{
      --brand-red:#c8102e;
      --brand-dark:#111827;
      --mpesa:#34b233;
      --paypal:#0070ba;
      --cash:#444;
      --bg:#f9fafb;
      --card:#ffffff;
      --muted:#6b7280;
      --ring:#e5e7eb;
      --success:#1ba94c;
    }
    *{box-sizing:border-box}
    body{font-family:'Segoe UI',system-ui,-apple-system,Arial,Helvetica,sans-serif;background:var(--bg);margin:0;color:#111}
    h1{margin:24px 0;text-align:center;color:var(--brand-red)}
    .container{max-width:880px;margin:24px auto;padding:20px}
    .section{background:var(--card);border:1px solid var(--ring);border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:20px;margin-bottom:18px}

    /* (1) Flip section */
    .flip-section{text-align:center}
    .flip-wrap{display:flex;gap:16px;justify-content:center;flex-wrap:wrap}
    .flip-card{width:240px;height:150px;perspective:1000px;cursor:pointer}
    .flip-inner{position:relative;width:100%;height:100%;transition:transform .6s;transform-style:preserve-3d}
    .flip-card:hover .flip-inner{transform:rotateY(180deg)}
    .flip-face{position:absolute;inset:0;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.15rem;color:#fff;backface-visibility:hidden}
    .flip-front{background:var(--brand-red)}
    .flip-back{background:var(--brand-dark);transform:rotateY(180deg)}

    /* Forms inside flip (kept as you had) */
    form{display:none;gap:12px;margin-top:18px}
    form.active{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    form h2{grid-column:1/-1;margin:.25rem 0 .5rem 0}
    form input, form textarea, form select{
      width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:1rem
    }
    form textarea{grid-column:1/-1}
    form input:focus, form textarea:focus, form select:focus{outline:none;border-color:var(--brand-red)}

    /* (2) Payment section */
    .payment-methods{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;margin-top:6px}
    .payment-method{
      padding:12px 18px;border-radius:12px;border:2px solid #e5e7eb;display:flex;align-items:center;gap:10px;
      font-weight:700;cursor:pointer;transition:all .25s;min-width:165px;justify-content:center;color:#fff
    }
    .payment-method:hover{transform:translateY(-2px)}
    .payment-method.selected{box-shadow:0 8px 18px rgba(0,0,0,.12);border-color:#111}
    #mpesaBtn,#mpesaBtn2{background:var(--mpesa)}
    #paypalBtn,#paypalBtn2{background:var(--paypal)}
    #codBtn,#codBtn2{background:var(--cash)}

    /* (3) Cart summary */
    .cart-summary h2{margin:0 0 10px 0}
    .cart-item{display:grid;grid-template-columns:1fr auto;gap:8px;padding:8px 0;border-bottom:1px dashed #e5e7eb}
    .cart-item:last-child{border-bottom:none}
    .muted{color:var(--muted)}
    .totals{margin-top:8px;text-align:right;font-weight:800}
    .totals small{display:block;color:var(--muted);font-weight:600}

    /* (4) Back grid */
    .footer-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .footer-grid button{
      padding:12px;border:none;border-radius:10px;background:#000;color:#fff;font-weight:700;cursor:pointer;transition:.25s
    }
    .footer-grid button:hover{background:var(--brand-red)}

    /* (5/6) Order button at the bottom */
    .order-btn{display:block;width:100%;padding:16px;
      font-size:clamp(1rem,4vw,1.2rem);font-weight:800;border:none;border-radius:12px;background:var(--success);color:#fff;cursor:pointer;transition:.25s}
    .order-btn:hover{background:#148a3b}

    /* Paypal containers */
    .paypal-wrap{margin-top:8px;display:none}
    .helper{font-size:.9rem;color:var(--muted)}
    @media(max-width:720px){
      form.active{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <h1>Checkout</h1>
  <div class="container">

    <!-- (1) Flip -->
    <div class="section flip-section">
      <div class="flip-wrap">
        <div class="flip-card" onclick="showForm('home')">
          <div class="flip-inner">
            <div class="flip-face flip-front">Home Delivery</div>
            <div class="flip-face flip-back">Deliver to your Door</div>
          </div>
        </div>
        <div class="flip-card" onclick="showForm('dine')">
          <div class="flip-inner">
            <div class="flip-face flip-front">Dine at Jiweke</div>
            <div class="flip-face flip-back">Reserve a Table</div>
          </div>
        </div>
      </div>

      <!-- Home form -->
      <form id="homeForm">
        <h2>üè† Home Delivery Details</h2>
        <input type="text" name="name" placeholder="Full Name" required/>
        <input type="email" name="email" placeholder="Email Address" required/>
        <textarea name="address" placeholder="Delivery Address" rows="3" required></textarea>
        <input type="tel" name="phone" placeholder="Phone Number (2547XXXXXXXX)" required/>

        <label class="helper" style="grid-column:1/-1">Choose a payment method below. If you pick PayPal, the PayPal button will appear.</label>
      </form>

      <!-- Dine form -->
      <form id="dineForm">
        <h2>üçΩÔ∏è Dine at Jiweke</h2>
        <input type="text" name="name" placeholder="Full Name" required/>
        <input type="email" name="email" placeholder="Email Address" required/>
        <input type="tel" name="phone" placeholder="Phone Number (2547XXXXXXXX)" required/>
        <select name="zone" required>
          <option value="">Select Dining Zone</option>
          <option>DJ Zone</option>
          <option>Pool Zone</option>
          <option>Garden Area</option>
          <option>Hall Area</option>
        </select>
        <label class="helper" style="grid-column:1/-1">Choose a payment method below. If you pick PayPal, the PayPal button will appear.</label>
      </form>
    </div>

    <!-- (2) Payment Gateway -->
    <div class="section">
      <h2 style="margin:0 0 12px 0;">üí≥ Payment</h2>
      <div class="payment-methods">
        <div class="payment-method" id="mpesaBtn"><i class="fa-solid fa-mobile-screen-button"></i>M-Pesa</div>
        <div class="payment-method" id="codBtn"><i class="fa-solid fa-money-bill"></i>Cash on Delivery</div>
        <div class="payment-method" id="paypalBtn"><i class="fa-brands fa-paypal"></i>PayPal</div>
      </div>
      <div class="paypal-wrap" id="paypal-wrap-1">
        <div id="paypal-button-container"></div>
      </div>

      <!-- Second set (if dine form is active) -->
      <div class="payment-methods" style="margin-top:14px">
        <div class="payment-method" id="mpesaBtn2"><i class="fa-solid fa-mobile-screen-button"></i>M-Pesa</div>
        <div class="payment-method" id="codBtn2"><i class="fa-solid fa-money-bill"></i>Cash on Delivery</div>
        <div class="payment-method" id="paypalBtn2"><i class="fa-brands fa-paypal"></i>PayPal</div>
      </div>
      <div class="paypal-wrap" id="paypal-wrap-2">
        <div id="paypal-button-container-2"></div>
      </div>
      <p class="helper" style="margin-top:8px">M-Pesa triggers a secure STK push to your phone (PIN entered on your handset). PayPal uses the smart button below.</p>
    </div>

    <!-- (3) Cart Summary -->
    <div class="section cart-summary" id="cartSummary">
      <h2>üõí Your Cart</h2>
      <div id="cartItems" class="muted">Loading‚Ä¶</div>
      <div class="totals">
        <div id="grandTotal">Total: KES 0.00</div>
        <small id="totalQty">Total Quantity: 0</small>
      </div>
    </div>

    <!-- (4) Back grid -->
    <div class="section">
      <div class="footer-grid">
        <button type="button" onclick="window.location.href='cart.html'">‚Üê Back to Cart</button>
        <button type="button" onclick="window.location.href='index.html'">Continue Shopping ‚Üí</button>
      </div>
    </div>

    <!-- (5 & 6) Place Order -->
    <div class="section">
      <button class="order-btn" id="placeOrderBtn">Place Order</button>
      <p class="helper" style="margin-top:8px">You‚Äôll receive a confirmation email, and so will we.</p>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  const API_BASE = ''; // same-origin; if your server runs elsewhere, e.g. 'https://yourdomain.com'
  // ====================

  // Flip control
  function showForm(type){
    document.getElementById('homeForm').classList.remove('active');
    document.getElementById('dineForm').classList.remove('active');
    if(type==='home') document.getElementById('homeForm').classList.add('active');
    else document.getElementById('dineForm').classList.add('active');
    // Reset PayPal visibility when switching
    document.querySelectorAll('.paypal-wrap').forEach(d=>d.style.display='none');
  }
  // Default to home form at load
  showForm('home');

  // Payment selection
  let selectedPayment = '';
  function clearSel(ids){ ids.forEach(id=>document.getElementById(id).classList.remove('selected')); }
  function paySelect(which){
    selectedPayment = which.id.startsWith('paypal') ? 'paypal'
                     : which.id.startsWith('mpesa')  ? 'mpesa'
                     : 'cod';

    // Highlight sets
    clearSel(['mpesaBtn','codBtn','paypalBtn']); clearSel(['mpesaBtn2','codBtn2','paypalBtn2']);
    which.classList.add('selected');

    // Toggle PayPal containers
    document.getElementById('paypal-wrap-1').style.display = (which.id==='paypalBtn') ? 'block' : 'none';
    document.getElementById('paypal-wrap-2').style.display = (which.id==='paypalBtn2') ? 'block' : 'none';
  }
  ['mpesaBtn','codBtn','paypalBtn','mpesaBtn2','codBtn2','paypalBtn2'].forEach(id=>{
    document.getElementById(id).addEventListener('click', e=>paySelect(e.currentTarget));
  });

  // Cart rendering from localStorage
  let cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const cartItems = document.getElementById('cartItems');
  const grandTotal = document.getElementById('grandTotal');
  const totalQty = document.getElementById('totalQty');
  function renderCart(){
    cartItems.innerHTML=''; let total=0; let qtyTotal=0;
    if(cart.length===0){
      cartItems.innerHTML='<p>Your cart is empty.</p>';
      grandTotal.textContent='Total: KES 0.00';
      totalQty.textContent='Total Quantity: 0';
      return;
    }
    cart.forEach(item=>{
      const qty = item.quantity || 1;
      const subtotal = (item.price || 0)*qty;
      total += subtotal; qtyTotal += qty;
      const row = document.createElement('div');
      row.className='cart-item';
      row.innerHTML = `<div>${item.name} <span class="muted">x${qty}</span></div><div>KES ${subtotal.toFixed(2)}</div>`;
      cartItems.appendChild(row);
    });
    grandTotal.textContent = `Total: KES ${total.toFixed(2)}`;
    totalQty.textContent = `Total Quantity: ${qtyTotal}`;
    return total;
  }
  let currentTotal = renderCart();

  // Helpers to get current active form data
  function activeFormData(){
    const homeActive = document.getElementById('homeForm').classList.contains('active');
    const form = homeActive ? document.getElementById('homeForm') : document.getElementById('dineForm');
    const fd = new FormData(form);
    const data = Object.fromEntries(fd.entries());
    return {
      deliveryType: homeActive ? 'home' : 'dine',
      name: data.name?.trim(),
      email: data.email?.trim(),
      phone: data.phone?.trim(),
      address: homeActive ? (data.address?.trim() || '') : (data.zone || 'Dine-In'),
    };
  }

  // Phone validator for Safaricom numbers
  function validKePhone(p){ return /^\d{12}$/.test(p) && p.startsWith('2547'); }

  // PayPal dynamic rendering (home)
  paypal.Buttons({
    createOrder: (data, actions) => {
      const total = (renderCart() || 0) / 160; // rough KES‚ÜíUSD if you want (edit as needed)
      const amount = Math.max(1, Number(total.toFixed(2))); // minimum 1
      return actions.order.create({ purchase_units: [{ amount: { value: String(amount) } }] });
    },
    onApprove: (data, actions) => actions.order.capture().then(details => {
      alert('‚úÖ PayPal payment completed by ' + details.payer.name.given_name);
      // You may also POST to your server to record/capture
    })
  }).render('#paypal-button-container');

  // PayPal dynamic rendering (dine)
  paypal.Buttons({
    createOrder: (data, actions) => {
      const total = (renderCart() || 0) / 160; // adjust conversion or switch currency
      const amount = Math.max(1, Number(total.toFixed(2)));
      return actions.order.create({ purchase_units: [{ amount: { value: String(amount) } }] });
    },
    onApprove: (data, actions) => actions.order.capture().then(details => {
      alert('‚úÖ PayPal payment completed by ' + details.payer.name.given_name);
    })
  }).render('#paypal-button-container-2');

  // Place Order handler
  document.getElementById('placeOrderBtn').addEventListener('click', async () => {
    if(cart.length===0) { alert('Cart is empty!'); return; }
    if(!selectedPayment){ alert('Please select a payment method.'); return; }

    const info = activeFormData();
    if(!info.name || !info.email || !info.phone){ alert('Fill in name, email, and phone.'); return; }
    if(info.deliveryType==='home' && !info.address){ alert('Add your delivery address.'); return; }
    if(!validKePhone(info.phone)){ alert('Phone must be in format 2547XXXXXXXX.'); return; }

    const totalKES = renderCart() || 0;

    // If M-Pesa, trigger STK first
    if(selectedPayment === 'mpesa'){
      try{
        const stkRes = await fetch(`${API_BASE}/api/mpesa/stkpush`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ phone: info.phone, amount: Math.max(1, Math.round(totalKES)) })
        });
        const stk = await stkRes.json();
        if(stk.ResponseCode !== '0'){
          alert('‚ùå M-Pesa STK push failed: ' + (stk.errorMessage || JSON.stringify(stk)));
          return;
        }
        alert('üì≤ STK Push sent. Enter your M-Pesa PIN on your phone to complete payment.');
      }catch(err){
        console.error(err);
        alert('‚ùå M-Pesa error, please try again.');
        return;
      }
    }

    // Send confirmation emails (to customer & to you)
    try{
      const orderPayload = {
        ...info,
        payment: selectedPayment,
        totalKES: Math.round(totalKES),
        cart
      };
      const emailRes = await fetch(`${API_BASE}/api/sendorder`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(orderPayload)
      });
      const r = await emailRes.json();
      if(!r.ok){ alert('‚ö†Ô∏è Order saved, but email failed.'); return; }

      alert('‚úÖ Order placed! We‚Äôve emailed you and the customer.');
      localStorage.removeItem('cart');
      window.location.href = 'index.html';
    }catch(err){
      console.error(err);
      alert('‚ùå Could not complete order.');
    }
  });
</script>
</body>
</html>
