<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout - Jiweke</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
body { font-family:'Segoe UI',sans-serif; background:#f5f5f5; margin:0; padding:20px; color:#333; }
h1 { text-align:center; color:#c8102e; margin-bottom:20px; font-size:2rem; }

/* Flip Section */
.flip-section { max-width:600px; margin:0 auto 30px; }
.flip-card { perspective:1000px; width:100%; }
.flip-card-inner { position:relative; transition: transform 0.8s; transform-style: preserve-3d; width:100%; }
.flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
.flip-card-front, .flip-card-back { backface-visibility:hidden; background:#fff; border-radius:12px; padding:25px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
.flip-card-back { transform:rotateY(180deg); }

/* Forms */
form { display:flex; flex-direction:column; gap:12px; }
input, select, textarea { padding:10px; border-radius:6px; border:1px solid #ccc; font-size:1rem; }
input:focus, select:focus, textarea:focus { border-color:#c8102e; outline:none; }

/* Payment Methods */
.payment-methods { display:flex; justify-content:center; gap:15px; flex-wrap:wrap; margin-bottom:20px; }
.payment-method { padding:10px 20px; border-radius:10px; cursor:pointer; border:1px solid #ccc; display:flex; align-items:center; gap:8px; transition:all 0.3s; }
.payment-method.selected { background:#c8102e; color:#fff; border-color:#c8102e; }

/* Cart Summary */
.cart-summary { max-width:650px; margin:0 auto 25px; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
.cart-summary h2 { margin-bottom:15px; font-size:1.5rem; }
.cart-item { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee; }
.cart-item:last-child { border-bottom:none; }
.total { font-weight:bold; text-align:right; margin-top:15px; }

/* Footer Grid */
.footer-grid { display:flex; justify-content:space-between; max-width:650px; margin:0 auto 20px; gap:10px; }
.footer-grid button { padding:12px 30px; border:none; border-radius:8px; cursor:pointer; font-size:1rem; background:#000; color:#fff; transition:all 0.3s; }
.footer-grid button:hover { background:#c8102e; }

/* Order Button */
.order-btn { display:block; width:100%; max-width:650px; margin:0 auto; padding:15px; font-size:1.2rem; font-weight:600; border:none; border-radius:10px; background:#1ba94c; color:#fff; cursor:pointer; transition:all 0.3s; }
.order-btn:hover { background:#148a3b; }

@media(max-width:600px){ .footer-grid{ flex-direction:column; } }
</style>
</head>
<body>
<h1>Checkout</h1>

<!-- 1Ô∏è‚É£ Delivery Section -->
<div class="flip-section">
  <div class="flip-card" id="flipCard">
    <div class="flip-card-inner">
      <div class="flip-card-front">
        <h2>üè† Home Delivery</h2>
        <form id="homeForm">
          <input type="text" name="name" placeholder="Full Name" required>
          <input type="email" name="email" placeholder="Email" required>
          <input type="tel" name="phone" placeholder="Phone Number" required>
          <textarea name="address" placeholder="Home Address" rows="3" required></textarea>
        </form>
        <div style="text-align:center; margin-top:10px; cursor:pointer; color:#c8102e;" onclick="flipCard()">Switch to Dine at Jiweke üçΩÔ∏è</div>
      </div>
      <div class="flip-card-back">
        <h2>üçΩÔ∏è Dine at Jiweke</h2>
        <form id="dineForm">
          <input type="text" name="name" placeholder="Full Name" required>
          <input type="email" name="email" placeholder="Email" required>
          <input type="tel" name="phone" placeholder="Phone Number" required>
          <select name="zone" required>
            <option value="">Select Dining Zone</option>
            <option value="indoor">Indoor</option>
            <option value="outdoor">Outdoor</option>
            <option value="vip">VIP Zone</option>
          </select>
        </form>
        <div style="text-align:center; margin-top:10px; cursor:pointer; color:#c8102e;" onclick="flipCard()">Switch to Home Delivery üè†</div>
      </div>
    </div>
  </div>
</div>

<!-- 2Ô∏è‚É£ Payment Section -->
<div class="payment-methods">
  <div class="payment-method" id="mpesaBtn"><i class="fa-solid fa-mobile-screen-button"></i> M-Pesa</div>
  <div class="payment-method" id="paypalBtn"><i class="fa-brands fa-paypal"></i> PayPal</div>
  <div class="payment-method" id="codBtn"><i class="fa-solid fa-money-bill"></i> Cash on Delivery</div>
</div>

<!-- 3Ô∏è‚É£ Cart Summary -->
<div class="cart-summary" id="cartSummary">
  <h2>Order Summary</h2>
  <div id="cartItems"></div>
  <div class="total" id="grandTotal">Total: KES 0.00</div>
  <div class="total" id="totalQty">Total Quantity: 0</div>
</div>

<!-- 4Ô∏è‚É£ Footer Grid -->
<div class="footer-grid">
  <button onclick="window.location.href='cart.html'">Back to Cart</button>
  <button onclick="window.location.href='index.html'">Back to Shopping</button>
</div>

<!-- 5Ô∏è‚É£ Place Order Button -->
<button class="order-btn" id="placeOrderBtn">Place Order</button>

<script>
let flipCardEl = document.getElementById('flipCard');
function flipCard(){ flipCardEl.classList.toggle('flipped'); }

// Cart Data
let cart = JSON.parse(localStorage.getItem('cart') || '[]');
const cartItems = document.getElementById('cartItems');
const grandTotal = document.getElementById('grandTotal');
const totalQty = document.getElementById('totalQty');
function renderCart(){
  cartItems.innerHTML=''; let total=0; let qtyTotal=0;
  if(cart.length===0){ cartItems.innerHTML='<p>Your cart is empty.</p>'; grandTotal.textContent='Total: KES 0.00'; totalQty.textContent='Total Quantity: 0'; return;}
  cart.forEach(item=>{
    const qty=item.quantity||1;
    const subtotal=item.price*qty;
    total+=subtotal;
    qtyTotal+=qty;
    const div=document.createElement('div');
    div.className='cart-item';
    div.innerHTML=`${item.name} x${qty} - KES ${subtotal.toFixed(2)}`;
    cartItems.appendChild(div);
  });
  grandTotal.textContent=`Total: KES ${total.toFixed(2)}`;
  totalQty.textContent=`Total Quantity: ${qtyTotal}`;
}
renderCart();

// Payment Selection
let selectedPayment='';
function highlightPayment(){document.querySelectorAll('.payment-method').forEach(btn=>btn.classList.remove('selected')); if(selectedPayment) document.getElementById(selectedPayment+'Btn').classList.add('selected');}
document.getElementById('mpesaBtn').addEventListener('click', ()=>{selectedPayment='mpesa'; highlightPayment();});
document.getElementById('paypalBtn').addEventListener('click', ()=>{selectedPayment='paypal'; highlightPayment();});
document.getElementById('codBtn').addEventListener('click', ()=>{selectedPayment='cod'; highlightPayment();});

// Place Order
document.getElementById('placeOrderBtn').addEventListener('click', async ()=>{
  if(cart.length===0){alert('Cart is empty!'); return;}
  if(!selectedPayment){alert('Choose a payment method first!'); return;}

  const deliveryType = flipCardEl.classList.contains('flipped') ? 'dine' : 'home';
  const form = deliveryType==='home'? document.getElementById('homeForm') : document.getElementById('dineForm');
  const name = form.name.value, email = form.email.value, phone = form.phone.value;
  const address = deliveryType==='home'? form.address.value : 'N/A';
  const total = cart.reduce((sum,item)=>sum+(item.price*(item.quantity||1)),0);

  if(selectedPayment==='mpesa'){
    const pin = prompt(`STK Push: Enter your M-Pesa PIN to pay KES ${total.toFixed(2)}`);
    if(!pin){alert('Payment cancelled'); return;}
    alert('‚úÖ Payment sent via M-Pesa!');
  }

  if(selectedPayment==='paypal'){
    try{
      const res = await fetch('http://localhost:3000/api/paypal/create-order',{
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({total})
      });
      const order = await res.json();
      if(order.id){
        const captureRes = await fetch('http://localhost:3000/api/paypal/capture-order',{
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({orderID:order.id})
        });
        const captureData = await captureRes.json();
        if(captureData.status==='COMPLETED'){
          alert('‚úÖ PayPal payment completed!');
        } else { alert('‚ùå PayPal payment failed'); return; }
      } else { alert('‚ùå Error creating PayPal order'); return; }
    } catch(e){ console.error(e); alert('‚ùå PayPal error'); return; }
  }

  if(selectedPayment==='cod'){ alert('‚úÖ Cash on Delivery selected!'); }

  // Send Order Email + SMS
  try{
    await fetch('http://localhost:3000/api/sendorder',{
      method:'POST', headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify({cart, name, email, phone, address, deliveryType, payment:selectedPayment, total})
    });
    alert('‚úÖ Order placed successfully! Email & SMS sent.');
    localStorage.removeItem('cart');
    window.location.href='index.html';
  }catch(e){console.error(e); alert('‚ùå Error sending order');}
});
</script>
</body>
</html>
